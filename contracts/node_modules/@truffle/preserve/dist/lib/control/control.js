"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.run = exports.control = void 0;
const controllers_1 = require("./controllers");
const types_1 = require("./types");
async function* control(controlOptions, methodOptions) {
    const { name, method } = controlOptions;
    const scope = [name || ""];
    const controller = new controllers_1.StepsController({ scope });
    const controls = {
        update: controller.update,
        declare: controller.declare,
        step: controller.step
    };
    yield* controller.begin();
    try {
        const completeMethodOptions = { ...methodOptions, controls };
        const result = yield* method(completeMethodOptions);
        yield* controller.succeed({ result });
        // check for error state (in case of cascaded failures)
        if (controller.state !== types_1.State.Done) {
            return;
        }
        return result;
    }
    catch (error) {
        yield* controller.fail({ error });
        return;
    }
}
exports.control = control;
const run = async (controlOptions, methodOptions) => {
    const generator = control(controlOptions, methodOptions);
    while (true) {
        const { done, value } = await generator.next();
        if (done) {
            return value;
        }
    }
};
exports.run = run;
//# sourceMappingURL=control.js.map